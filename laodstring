local G2L = {}
local coinFarmActive = false
local afkEnabled = false
local bodyVelocity = nil

-- ========== PERSISTENT GUI SETUP ========== --
local player = game:GetService("Players").LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Main GUI
local mainGui = Instance.new("ScreenGui", playerGui)
mainGui.Name = "MainGUI"
mainGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
mainGui.ResetOnSpawn = false -- Ensures GUI persists after respawn

-- Anti-AFK GUI
local afkGui = Instance.new("ScreenGui", playerGui)
afkGui.Name = "AntiAFK"
afkGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
afkGui.ResetOnSpawn = false -- Ensures GUI persists after respawn

-- ========== MAIN GUI CONSTRUCTION ========== --
local mainFrame = Instance.new("Frame", mainGui)
mainFrame.BorderSizePixel = 0
mainFrame.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
mainFrame.Style = Enum.FrameStyle.RobloxRound
mainFrame.Size = UDim2.new(0, 272, 0, 383)
mainFrame.Position = UDim2.new(0.36689, 0, 0.29555, 0)
mainFrame.BorderColor3 = Color3.fromRGB(0, 0, 0)
mainFrame.Name = "Main"

-- Make GUI draggable
local dragging
local dragInput
local dragStart
local startPos

local function updateInput(input)
    local delta = input.Position - dragStart
    mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

mainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = mainFrame.Position

        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

mainFrame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)

game:GetService("UserInputService").InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        updateInput(input)
    end
end)

-- Title Label
local titleLabel = Instance.new("TextLabel", mainFrame)
titleLabel.TextWrapped = true
titleLabel.BorderSizePixel = 0
titleLabel.TextSize = 14
titleLabel.TextScaled = true
titleLabel.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
titleLabel.FontFace = Font.new([[rbxasset://fonts/families/PressStart2P.json]], Enum.FontWeight.Regular, Enum.FontStyle.Normal)
titleLabel.TextColor3 = Color3.fromRGB(0, 0, 0)
titleLabel.Size = UDim2.new(0, 200, 0, 50)
titleLabel.BorderColor3 = Color3.fromRGB(0, 0, 0)
titleLabel.Text = "Critic MM2 AutoFarmüçã"

local titleCorner = Instance.new("UICorner", titleLabel)
local titleStroke = Instance.new("UIStroke", titleLabel)
titleStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
titleStroke.Thickness = 3
titleStroke.Color = Color3.fromRGB(109, 109, 109)

-- Minimize Button
local minimizeButton = Instance.new("TextButton", mainFrame)
minimizeButton.TextWrapped = true
minimizeButton.BorderSizePixel = 0
minimizeButton.TextColor3 = Color3.fromRGB(0, 0, 0)
minimizeButton.TextSize = 14
minimizeButton.TextScaled = true
minimizeButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
minimizeButton.FontFace = Font.new([[rbxasset://fonts/families/PressStart2P.json]], Enum.FontWeight.Regular, Enum.FontStyle.Normal)
minimizeButton.Size = UDim2.new(0, 49, 0, 49)
minimizeButton.Name = "Minimize"
minimizeButton.BorderColor3 = Color3.fromRGB(0, 0, 0)
minimizeButton.Text = "Minmize"
minimizeButton.Position = UDim2.new(0.81741, 0, -0.00224, 0)

local minimizeCorner = Instance.new("UICorner", minimizeButton)
local minimizeStroke = Instance.new("UIStroke", minimizeButton)
minimizeStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
minimizeStroke.Thickness = 3
minimizeStroke.Color = Color3.fromRGB(109, 109, 109)

-- Background Image
local backgroundImage = Instance.new("ImageLabel", mainFrame)
backgroundImage.BorderSizePixel = 0
backgroundImage.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
backgroundImage.Image = "http://www.roblox.com/asset/?id=2100841516"
backgroundImage.Size = UDim2.new(0, 245, 0, 297)
backgroundImage.BorderColor3 = Color3.fromRGB(0, 0, 0)
backgroundImage.Name = "Backround"
backgroundImage.Position = UDim2.new(0.028, 0, 0.18413, 0)

-- Coin Farm Button
local coinButton = Instance.new("TextButton", mainFrame)
coinButton.TextWrapped = true
coinButton.BorderSizePixel = 0
coinButton.TextColor3 = Color3.fromRGB(0, 0, 0)
coinButton.TextSize = 14
coinButton.TextScaled = true
coinButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
coinButton.FontFace = Font.new([[rbxasset://fonts/families/PressStart2P.json]], Enum.FontWeight.Regular, Enum.FontStyle.Normal)
coinButton.Size = UDim2.new(0, 200, 0, 50)
coinButton.Name = "Coin"
coinButton.BorderColor3 = Color3.fromRGB(0, 0, 0)
coinButton.Text = "Coin Farm"
coinButton.Style = Enum.ButtonStyle.RobloxRoundDefaultButton
coinButton.Position = UDim2.new(0.02768, 0, 0.19622, 0)

local coinCorner = Instance.new("UICorner", coinButton)

-- Kill Button
local killButton = Instance.new("TextButton", mainFrame)
killButton.TextWrapped = true
killButton.BorderSizePixel = 0
killButton.TextColor3 = Color3.fromRGB(0, 0, 0)
killButton.TextSize = 14
killButton.TextScaled = true
killButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
killButton.FontFace = Font.new([[rbxasset://fonts/families/PressStart2P.json]], Enum.FontWeight.Regular, Enum.FontStyle.Normal)
killButton.Size = UDim2.new(0, 200, 0, 50)
killButton.Name = "Kill"
killButton.BorderColor3 = Color3.fromRGB(0, 0, 0)
killButton.Text = "Fling all when bag full"
killButton.Style = Enum.ButtonStyle.RobloxRoundDefaultButton
killButton.Position = UDim2.new(0.02906, 0, 0.37118, 0)

local killCorner = Instance.new("UICorner", killButton)

-- Anti-AFK Button
local afkButton = Instance.new("TextButton", mainFrame)
afkButton.TextWrapped = true
afkButton.BorderSizePixel = 0
afkButton.TextColor3 = Color3.fromRGB(0, 0, 0)
afkButton.TextSize = 14
afkButton.TextScaled = true
afkButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
afkButton.FontFace = Font.new([[rbxasset://fonts/families/PressStart2P.json]], Enum.FontWeight.Regular, Enum.FontStyle.Normal)
afkButton.Size = UDim2.new(0, 200, 0, 50)
afkButton.Name = "AFK"
afkButton.BorderColor3 = Color3.fromRGB(0, 0, 0)
afkButton.Text = "Anti - AFK"
afkButton.Style = Enum.ButtonStyle.RobloxRoundDefaultButton
afkButton.Position = UDim2.new(0.02735, 0, 0.54366, 0)

local afkCorner = Instance.new("UICorner", afkButton)

-- Info Label
local infoLabel = Instance.new("TextLabel", mainFrame)
infoLabel.TextWrapped = true
infoLabel.BorderSizePixel = 0
infoLabel.TextSize = 14
infoLabel.TextScaled = true
infoLabel.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
infoLabel.FontFace = Font.new([[rbxasset://fonts/families/PressStart2P.json]], Enum.FontWeight.Regular, Enum.FontStyle.Normal)
infoLabel.TextColor3 = Color3.fromRGB(0, 0, 0)
infoLabel.Size = UDim2.new(0, 200, 0, 50)
infoLabel.BorderColor3 = Color3.fromRGB(0, 0, 0)
infoLabel.Text = "Took me a long time to make this, also i made this gui becasue my main ui didnt work for some reasons."
infoLabel.Position = UDim2.new(0.05515, 0, 0.71279, 0)

local infoCorner = Instance.new("UICorner", infoLabel)
local infoStroke = Instance.new("UIStroke", infoLabel)
infoStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
infoStroke.Thickness = 3
infoStroke.Color = Color3.fromRGB(109, 109, 109)

-- ========== ANTI-AFK GUI CONSTRUCTION ========== --
local afkFrame = Instance.new("Frame", afkGui)
afkFrame.BorderSizePixel = 0
afkFrame.BackgroundColor3 = Color3.fromRGB(209, 209, 209)
afkFrame.Size = UDim2.new(0, 255, 0, 140)
afkFrame.Position = UDim2.new(0.74392, 0, 0.69715, 0)
afkFrame.Visible = false -- Hidden by default

local afkTitle = Instance.new("TextLabel", afkFrame)
afkTitle.TextWrapped = true
afkTitle.BorderSizePixel = 0
afkTitle.TextSize = 14
afkTitle.TextScaled = true
afkTitle.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
afkTitle.FontFace = Font.new([[rbxasset://fonts/families/PressStart2P.json]], Enum.FontWeight.Regular, Enum.FontStyle.Normal)
afkTitle.TextColor3 = Color3.fromRGB(0, 0, 0)
afkTitle.Size = UDim2.new(0, 255, 0, 50)
afkTitle.BorderColor3 = Color3.fromRGB(0, 0, 0)
afkTitle.Text = "Critc Anti - AFK üçã"

local afkTitleCorner = Instance.new("UICorner", afkTitle)
local afkTitleStroke = Instance.new("UIStroke", afkTitle)
afkTitleStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
afkTitleStroke.Thickness = 3
afkTitleStroke.Color = Color3.fromRGB(255, 255, 0)

local afkStatus = Instance.new("TextLabel", afkFrame)
afkStatus.TextWrapped = true
afkStatus.BorderSizePixel = 0
afkStatus.TextSize = 14
afkStatus.TextScaled = true
afkStatus.BackgroundColor3 = Color3.fromRGB(86, 255, 128)
afkStatus.FontFace = Font.new([[rbxasset://fonts/families/PressStart2P.json]], Enum.FontWeight.Regular, Enum.FontStyle.Normal)
afkStatus.TextColor3 = Color3.fromRGB(0, 0, 0)
afkStatus.Size = UDim2.new(0, 200, 0, 50)
afkStatus.BorderColor3 = Color3.fromRGB(0, 0, 0)
afkStatus.Text = "Active"
afkStatus.Position = UDim2.new(0.10588, 0, 0.50714, 0)

local afkFrameStroke = Instance.new("UIStroke", afkFrame)
afkFrameStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
afkFrameStroke.Thickness = 3

-- ========== COIN FARM TOGGLE ========== --
local function toggleCoinFarm()
    coinFarmActive = not coinFarmActive
    coinButton.TextColor3 = coinFarmActive and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(0, 0, 0)
    
    if coinFarmActive then
        -- Initialize farm
        local character = player.Character or player.CharacterAdded:Wait()
        local hrp = character:WaitForChild("HumanoidRootPart")
        
        -- Movement control
        bodyVelocity = Instance.new("BodyVelocity")
        bodyVelocity.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
        bodyVelocity.Parent = hrp

        -- Farm loop
        task.spawn(function()
            while coinFarmActive and character and hrp do
                -- Find all coins
                local coins = {}
                for _, coin in ipairs(workspace:GetDescendants()) do
                    if coin:IsA("MeshPart") and coin.Name == "MainCoin" then
                        table.insert(coins, coin)
                    end
                end

                -- Find the closest coin
                local closestCoin = nil
                local closestDistance = math.huge
                for _, coin in ipairs(coins) do
                    local distance = (hrp.Position - coin.Position).Magnitude
                    if distance < closestDistance then
                        closestDistance = distance
                        closestCoin = coin
                    end
                end

                -- Move toward the closest coin
                if closestCoin then
                    local direction = (closestCoin.Position - hrp.Position).Unit
                    bodyVelocity.Velocity = direction * 50 -- Adjust speed as needed
                else
                    bodyVelocity.Velocity = Vector3.zero
                end

                task.wait()
            end

            -- Cleanup when loop ends
            if bodyVelocity then
                bodyVelocity:Destroy()
                bodyVelocity = nil
            end
        end)
    else
        -- Cleanup
        if bodyVelocity then
            bodyVelocity:Destroy()
            bodyVelocity = nil
        end
    end
end

coinButton.MouseButton1Click:Connect(toggleCoinFarm)

-- ========== ANTI-AFK TOGGLE ========== --
afkButton.MouseButton1Click:Connect(function()
    if not afkEnabled then
        afkEnabled = true
        afkButton.TextColor3 = Color3.fromRGB(128, 0, 128)
        afkFrame.Visible = true
        
        -- Anti-AFK functionality
        local virtualUser = game:GetService("VirtualUser")
        player.Idled:Connect(function()
            virtualUser:CaptureController()
            virtualUser:ClickButton2(Vector2.new())
            afkStatus.Text = "Kicked AFK detection! Still active."
            task.wait(2)
            afkStatus.Text = "Status: Active"
        end)
    end
end)

-- ========== RESPAWN HANDLING ========== --
player.CharacterAdded:Connect(function(character)
    if coinFarmActive then
        -- Reinitialize farm components
        toggleCoinFarm() -- Force refresh
        toggleCoinFarm()
    end
end)
