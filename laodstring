-- GUI Setup
local G2L = {};

-- StarterGui.ScreenGui
G2L["1"] = Instance.new("ScreenGui", game:GetService("Players").LocalPlayer:WaitForChild("PlayerGui"));
G2L["1"]["ZIndexBehavior"] = Enum.ZIndexBehavior.Sibling;

-- StarterGui.ScreenGui.Main
G2L["2"] = Instance.new("Frame", G2L["1"]);
G2L["2"]["BorderSizePixel"] = 0;
G2L["2"]["BackgroundColor3"] = Color3.fromRGB(255, 255, 255);
G2L["2"]["Style"] = Enum.FrameStyle.RobloxRound;
G2L["2"]["Size"] = UDim2.new(0, 272, 0, 383);
G2L["2"]["Position"] = UDim2.new(0.36689, 0, 0.29555, 0);
G2L["2"]["BorderColor3"] = Color3.fromRGB(0, 0, 0);
G2L["2"]["Name"] = "Main";

-- Add Text Label for the Title
G2L["3"] = Instance.new("TextLabel", G2L["2"]);
G2L["3"]["TextWrapped"] = true;
G2L["3"]["BorderSizePixel"] = 0;
G2L["3"]["TextSize"] = 14;
G2L["3"]["TextScaled"] = true;
G2L["3"]["BackgroundColor3"] = Color3.fromRGB(255, 255, 255);
G2L["3"]["FontFace"] = Font.new("rbxasset://fonts/families/PressStart2P.json", Enum.FontWeight.Regular, Enum.FontStyle.Normal);
G2L["3"]["TextColor3"] = Color3.fromRGB(0, 0, 0);
G2L["3"]["Size"] = UDim2.new(0, 200, 0, 50);
G2L["3"]["Text"] = "Critic MM2 AutoFarmðŸ‹";

-- Add Button for Coin Farm
G2L["a"] = Instance.new("TextButton", G2L["2"]);
G2L["a"]["TextWrapped"] = true;
G2L["a"]["BorderSizePixel"] = 0;
G2L["a"]["TextColor3"] = Color3.fromRGB(0, 0, 0);
G2L["a"]["TextSize"] = 14;
G2L["a"]["TextScaled"] = true;
G2L["a"]["BackgroundColor3"] = Color3.fromRGB(255, 255, 255);
G2L["a"]["FontFace"] = Font.new("rbxasset://fonts/families/PressStart2P.json", Enum.FontWeight.Regular, Enum.FontStyle.Normal);
G2L["a"]["Size"] = UDim2.new(0, 200, 0, 50);
G2L["a"]["Text"] = "Coin Farm";
G2L["a"]["Position"] = UDim2.new(0.02768, 0, 0.19622, 0);

-- Add button corner and stroke
G2L["b"] = Instance.new("UICorner", G2L["a"]);

-- Coin Farm Script Logic
local player = game:GetService("Players").LocalPlayer
local FLY_SPEED = 26 -- Updated speed of movement
local ARRIVAL_THRESHOLD = 1 -- Distance threshold to stop
local visitedCoins = {}

-- Function to initialize the character
local function initializeCharacter(character)
    local hrp = character:WaitForChild("HumanoidRootPart")

    -- Enable noclip for the character
    game:GetService("RunService").Stepped:Connect(function()
        for _, part in ipairs(character:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = false
            end
        end
    end)

    -- Create a BodyVelocity object for smooth movement
    local bodyVelocity = Instance.new("BodyVelocity")
    bodyVelocity.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
    bodyVelocity.Velocity = Vector3.zero
    bodyVelocity.Parent = hrp

    -- Function to move the character to a target position
    local function forceMoveTo(targetPos)
        local startTime = tick()

        while (hrp.Position - targetPos).Magnitude > ARRIVAL_THRESHOLD do
            if tick() - startTime > 10 then -- Timeout after 10 seconds
                bodyVelocity.Velocity = Vector3.zero
                return false
            end

            -- Calculate direction and set velocity
            local direction = (targetPos - hrp.Position).Unit
            bodyVelocity.Velocity = direction * FLY_SPEED
            task.wait()
        end

        bodyVelocity.Velocity = Vector3.zero
        return true
    end

    -- Function to get all uncollected coins
    local function getCoins()
        local coins = {}
        for _, coin in ipairs(workspace:GetDescendants()) do
            if coin:IsA("MeshPart") and coin.Name == "MainCoin" and not visitedCoins[coin] then
                table.insert(coins, coin)
            end
        end
        return coins
    end

    -- Function to find the closest coin
    local function getClosestCoin()
        local coins = getCoins()
        local closestCoin = nil
        local shortestDistance = math.huge

        for _, coin in ipairs(coins) do
            local distance = (hrp.Position - coin.Position).Magnitude
            if distance < shortestDistance then
                shortestDistance = distance
                closestCoin = coin
            end
        end

        return closestCoin
    end

    -- Main loop to collect coins
    while true do
        local coin = getClosestCoin()

        if not coin then
            -- No coins left, wait and check again
            task.wait(5)
            continue
        end

        -- Move to the coin
        local targetPos = coin.Position
        if forceMoveTo(targetPos) then
            visitedCoins[coin] = true
            coin:Destroy() -- Destroy the coin locally
        end

        task.wait(0.1) -- Small delay before checking for the next coin
    end
end

-- Handle character initialization and respawning
local function onCharacterAdded(character)
    initializeCharacter(character)
end

-- Connect the character added event
player.CharacterAdded:Connect(onCharacterAdded)

-- Initialize the current character if it already exists
if player.Character then
    onCharacterAdded(player.Character)
end

-- Button click event to trigger the Coin Farm
G2L["a"].MouseButton1Click:Connect(function()
    -- Start the coin farm script when the button is clicked
    print("Coin Farm Started!")
    -- Call the character initialization logic to start coin collecting
    if player.Character then
        initializeCharacter(player.Character)
    end
end)

return G2L["1"], require;
