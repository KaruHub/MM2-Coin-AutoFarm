local player = game:GetService("Players").LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local TweenService = game:GetService("TweenService")

-- GUI Setup
local mainGui = Instance.new("ScreenGui", playerGui)
mainGui.Name = "MainGUI"
mainGui.ResetOnSpawn = false
mainGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

local mainFrame = Instance.new("Frame", mainGui)
mainFrame.Size = UDim2.new(0, 275, 0, 385)
mainFrame.Position = UDim2.new(0.35, 0, 0.3, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
mainFrame.Active = true
mainFrame.Draggable = true

local titleBar = Instance.new("Frame", mainGui)
titleBar.Size = UDim2.new(0, 275, 0, 30)
titleBar.Position = mainFrame.Position
titleBar.BackgroundColor3 = Color3.fromRGB(30, 30, 30)

local titleText = Instance.new("TextLabel", titleBar)
titleText.Size = UDim2.new(0.7, 0, 1, 0)
titleText.Text = "Critic MM2 AutoFarm"
titleText.TextColor3 = Color3.new(1, 1, 1)
titleText.Font = Enum.Font.PressStart2P

local minimizeButton = Instance.new("TextButton", titleBar)
minimizeButton.Size = UDim2.new(0.25, 0, 1, 0)
minimizeButton.Position = UDim2.new(0.75, 0, 0, 0)
minimizeButton.Text = "▬"
minimizeButton.TextColor3 = Color3.new(1, 1, 1)

-- GUI Elements
local coinButton = Instance.new("TextButton", mainFrame)
coinButton.Size = UDim2.new(0.9, 0, 0.15, 0)
coinButton.Position = UDim2.new(0.05, 0, 0.1, 0)
coinButton.Text = "Coin Farm"
coinButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
coinButton.TextColor3 = Color3.new(1, 1, 1)

local afkButton = Instance.new("TextButton", mainFrame)
afkButton.Size = UDim2.new(0.9, 0, 0.15, 0)
afkButton.Position = UDim2.new(0.05, 0, 0.3, 0)
afkButton.Text = "Anti-AFK"
afkButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
afkButton.TextColor3 = Color3.new(1, 1, 1)

local statusLabel = Instance.new("TextLabel", mainFrame)
statusLabel.Size = UDim2.new(0.9, 0, 0.4, 0)
statusLabel.Position = UDim2.new(0.05, 0, 0.5, 0)
statusLabel.Text = "Status: Ready"
statusLabel.TextWrapped = true
statusLabel.TextColor3 = Color3.new(1, 1, 1)

-- System Variables
local coinFarmActive = false
local afkEnabled = false
local coinCount = 0
local currentVelocity
local noclipConnection

-- Minimize Function
minimizeButton.MouseButton1Click:Connect(function()
    mainFrame.Visible = not mainFrame.Visible
    minimizeButton.Text = mainFrame.Visible and "▬" or "▭"
end)

-- Smooth Movement Function
local function smoothMoveTo(target, hrp)
    local tweenInfo = TweenInfo.new(
        (target.Position - hrp.Position).Magnitude / 30,
        Enum.EasingStyle.Linear
    )
    
    local tween = TweenService:Create(hrp, tweenInfo, {
        CFrame = CFrame.new(target.Position + Vector3.new(0, 3, 0))
    })
    
    tween:Play()
    tween.Completed:Wait()
    return true
end

-- Coin Farm System
local function startCoinFarm()
    local character = player.Character or player.CharacterAdded:Wait()
    local hrp = character:WaitForChild("HumanoidRootPart")
    
    -- Noclip implementation
    noclipConnection = game:GetService("RunService").Stepped:Connect(function()
        for _, part in ipairs(character:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = false
            end
        end
    end)

    while coinFarmActive do
        local closestCoin
        local closestDistance = math.huge
        
        -- Find nearest coin
        for _, obj in ipairs(workspace:GetDescendants()) do
            if obj.Name == "MainCoin" and obj:IsA("MeshPart") then
                local distance = (hrp.Position - obj.Position).Magnitude
                if distance < closestDistance then
                    closestDistance = distance
                    closestCoin = obj
                end
            end
        end

        if closestCoin then
            if smoothMoveTo(closestCoin, hrp) then
                closestCoin:Destroy()
                coinCount += 1
                statusLabel.Text = "Coins Collected: "..coinCount
                
                -- Coin counter logic
                if coinCount >= 40 then
                    print("CoinFullC")
                    wait(2)
                    print("CoinFullC")
                    coinCount = 0
                end
            end
        else
            wait(3)
        end
    end
end

-- Toggle Systems
coinButton.MouseButton1Click:Connect(function()
    coinFarmActive = not coinFarmActive
    coinButton.TextColor3 = coinFarmActive and Color3.new(0, 1, 0) or Color3.new(1, 1, 1)
    
    if coinFarmActive then
        statusLabel.Text = "Status: Coin Farm Active"
        task.spawn(startCoinFarm)
    else
        statusLabel.Text = "Status: Coin Farm Inactive"
        if noclipConnection then
            noclipConnection:Disconnect()
        end
    end
end)

afkButton.MouseButton1Click:Connect(function()
    if not afkEnabled then
        afkEnabled = true
        afkButton.TextColor3 = Color3.new(0.5, 0, 0.5)
        
        local virtualUser = game:GetService("VirtualUser")
        player.Idled:Connect(function()
            virtualUser:CaptureController()
            virtualUser:ClickButton2(Vector2.new())
            statusLabel.Text = "Anti-AFK: Active"
        end)
    end
end)

-- Respawn Handling
player.CharacterAdded:Connect(function()
    if coinFarmActive then
        coinFarmActive = false
        task.wait(1)
        coinFarmActive = true
        startCoinFarm()
    end
end)
